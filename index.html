<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopify AI Analytics</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js for rendering Markdown from the AI -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .prose h3 { margin-top: 1em; margin-bottom: 0.5em; font-size: 1.25rem; font-weight: 600; }
        .prose ul { list-style-type: disc; margin-left: 1.5em; }
        .prose li { margin-bottom: 0.5em; }
        .prose p { margin-bottom: 1em; }
        .prose strong { font-weight: 600; }
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #4f46e5; /* Indigo */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <script>
        // Basic dark mode setup
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Shopify AI Analytics</h1>
            <button id="theme-toggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700">
                <!-- Icon will be inserted by JS -->
            </button>
        </header>

        <!-- Main Action Card -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 md:p-8 mb-8">
            <h2 class="text-xl font-semibold mb-2">Get AI-Powered Insights</h2>
            <p class="text-gray-600 dark:text-gray-400 mb-6">Click the button below to fetch the last 30 days of order data from your Shopify store and let Gemini analyze it for hidden trends and actionable insights.</p>
            <button id="analyze-button" class="w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:bg-indigo-400 disabled:cursor-wait transition-all duration-200">
                Analyze Store Data
            </button>
        </div>

        <!-- Results Section -->
        <div id="results-container">
            <!-- Loader will be injected here -->
            <!-- Error message will be injected here -->
            <!-- AI insights will be injected here -->
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const analyzeButton = document.getElementById('analyze-button');
            const resultsContainer = document.getElementById('results-container');
            const themeToggle = document.getElementById('theme-toggle');

            // --- Theme Toggling ---
            const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`;
            const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`;

            const updateThemeIcon = () => {
                themeToggle.innerHTML = document.documentElement.classList.contains('dark') ? sunIcon : moonIcon;
            };

            themeToggle.addEventListener('click', () => {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                updateThemeIcon();
            });

            updateThemeIcon(); // Set initial icon

            // --- Main Logic ---
            analyzeButton.addEventListener('click', async () => {
                // 1. Disable button and show loader
                analyzeButton.disabled = true;
                analyzeButton.textContent = 'Analyzing...';
                resultsContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8">
                        <div class="loader"></div>
                        <p class="mt-4 text-gray-600 dark:text-gray-400">Fetching Shopify data and warming up the AI...</p>
                    </div>`;

                try {
                    // 2. Fetch data from our secure serverless function.
                    // FIX: Using the full, absolute URL to your deployed function.
                    const functionUrl = `https://admirable-tulumba-98b343.netlify.app/.netlify/functions/analytics`;
                    const response = await fetch(functionUrl);
                    
                    if (!response.ok) {
                        throw new Error(`Failed to fetch Shopify data. Server responded with ${response.status}.`);
                    }
                    const shopifyData = await response.json();

                    // Check if the server-side function returned an error
                    if (shopifyData.error) {
                        throw new Error(shopifyData.error);
                    }

                    // 3. Call Gemini AI for analysis
                    const aiInsights = await getAiAnalysis(shopifyData.orders);

                    // 4. Display the results
                    resultsContainer.innerHTML = `
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 md:p-8">
                            <h2 class="text-2xl font-bold mb-4 text-gray-900 dark:text-white">AI-Generated Insights</h2>
                            <div class="prose prose-indigo dark:prose-invert max-w-none">${marked.parse(aiInsights)}</div>
                        </div>
                    `;

                } catch (error) {
                    console.error('Analysis failed:', error);
                    resultsContainer.innerHTML = `
                        <div class="bg-red-100 dark:bg-red-900/20 border-l-4 border-red-500 text-red-700 dark:text-red-200 p-6 rounded-lg shadow-md">
                            <h3 class="font-bold">An Error Occurred</h3>
                            <p>${error.message}</p>
                            <p class="mt-2 text-sm">Please check the browser console and your serverless function logs for more details.</p>
                        </div>`;
                } finally {
                    // 5. Re-enable the button
                    analyzeButton.disabled = false;
                    analyzeButton.textContent = 'Analyze Store Data';
                }
            });

            async function getAiAnalysis(orders) {
                // This is the prompt we send to the Gemini API.
                // It's important to give the AI a clear role and instructions.
                const prompt = `
                    You are an expert e-commerce data analyst for a Shopify store.
                    Based on the following raw order data (in JSON format) from the last 30 days,
                    please provide a concise summary of actionable insights.

                    Focus on:
                    1.  **Sales Trends:** Are sales growing, declining, or flat? Are there specific days of the week that are stronger or weaker?
                    2.  **Customer Behavior:** What is the average order value (AOV)? Are there any patterns in the products being purchased together?
                    3.  **Anomalies:** Are there any unusual spikes or dips in sales that need investigation?
                    4.  **Actionable Advice:** Based on these insights, provide 2-3 specific, actionable recommendations for the store owner to increase sales or improve operations.

                    Present your findings in clear, easy-to-understand Markdown format. Use headings, bold text, and bullet points.

                    Here is the order data:
                    ${JSON.stringify(orders, null, 2)}
                `;

                // The API key is left blank here. The Canvas environment will inject it.
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{
                        role: "user",
                        parts: [{ text: prompt }]
                    }],
                    generationConfig: {
                        temperature: 0.5,
                        topK: 1,
                        topP: 1,
                        maxOutputTokens: 2048,
                    },
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error("Gemini API Error:", errorBody);
                    throw new Error("The AI model failed to generate a response.");
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    throw new Error("Received an empty or invalid response from the AI model.");
                }
            }
        });
    </script>
</body>
</html>

